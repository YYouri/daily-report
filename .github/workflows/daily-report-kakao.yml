name: Daily Report + Kakao Notify

on:
  schedule:
    - cron: "45 12 * * *"    # ÌïúÍµ≠ÏãúÍ∞Ñ Ïò§Ï†Ñ 9Ïãú Ïã§Ìñâ
  workflow_dispatch:

jobs:
  report_and_notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install curl & jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 1. Ï£ºÏãù Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÇºÏÑ±Ï†ÑÏûê, Ïï†Ìîå, ÎÇòÏä§Îã•)
      - name: Fetch stock data
        run: |
          curl -s "https://query1.finance.yahoo.com/v7/finance/quote?symbols=005930.KS,AAPL,IXIC" > stock.json

      # 2. ÌôòÏú® Í∞ÄÏ†∏Ïò§Í∏∞
      - name: Fetch FX data
        run: |
          curl -s "https://api.exchangerate.host/latest?base=USD" > fx.json

      # 3. Markdown Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
      - name: Generate Markdown Report
        run: |
          DATE=$(date +"%Y-%m-%d")
          mkdir -p reports/$DATE

          SSEC=$(jq '.quoteResponse.result[0].regularMarketPrice' stock.json)
          AAPL=$(jq '.quoteResponse.result[1].regularMarketPrice' stock.json)
          NASDAQ=$(jq '.quoteResponse.result[2].regularMarketPrice' stock.json)
          USDKRW=$(jq '.rates.KRW' fx.json)

          echo "# üìä Daily Market Report - $DATE" > reports/$DATE/daily-report-$DATE.md
          echo "" >> reports/$DATE/daily-report-$DATE.md
          echo "## üìà Stock Prices" >> reports/$DATE/daily-report-$DATE.md
          echo "- **Samsung Electronics (005930.KS)**: $SSEC KRW" >> reports/$DATE/daily-report-$DATE.md
          echo "- **Apple (AAPL)**: \$${AAPL}" >> reports/$DATE/daily-report-$DATE.md
          echo "- **NASDAQ (IXIC)**: ${NASDAQ}" >> reports/$DATE/daily-report-$DATE.md
          echo "" >> reports/$DATE/daily-report-$DATE.md
          echo "## üí± Exchange Rate" >> reports/$DATE/daily-report-$DATE.md
          echo "- **USD ‚Üí KRW**: ${USDKRW}" >> reports/$DATE/daily-report-$DATE.md
          echo "" >> reports/$DATE/daily-report-$DATE.md
          echo "---" >> reports/$DATE/daily-report-$DATE.md
          echo "GitHub Actions ÏûêÎèô ÏÉùÏÑ± Î¶¨Ìè¨Ìä∏" >> reports/$DATE/daily-report-$DATE.md

          # Ïπ¥Ïπ¥Ïò§ÌÜ°ÏúºÎ°ú Î≥¥ÎÇº ÏöîÏïΩ ÏÉùÏÑ±
          echo "üìä $DATE Î¶¨Ìè¨Ìä∏\nÏÇºÏÑ±Ï†ÑÏûê: $SSEC KRW\nÏï†Ìîå: $AAPL USD\nÎÇòÏä§Îã•: $NASDAQ\nUSD‚ÜíKRW: $USDKRW" > report.txt

      # 4. RepoÏóê Ïª§Î∞ã
      - name: Commit report
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add reports/*
          git commit -m "Daily report update" || echo "No changes"
          git push

      # 5. Ïπ¥Ïπ¥Ïò§ÌÜ°ÏúºÎ°ú ÏïåÎ¶º Î≥¥ÎÇ¥Í∏∞
      - name: Send Kakao Talk Message
        run: |
          MSG=$(cat report.txt | sed 's/"/\\"/g')
          curl -v -X POST "https://kapi.kakao.com/v2/api/talk/memo/default/send" \
            -H "Authorization: Bearer ${{ secrets.KAKAO_ACCESS_TOKEN }}" \
            --data-urlencode "template_object={
              \"object_type\":\"text\",
              \"text\":\"$MESSAGE\",
              \"link\":{\"web_url\":\"https://github.com\"}
            }"
